
services:
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    command: ["azurite-blob", "--blobHost", "0.0.0.0"] # for non e2e test
    extra_hosts:
      - "devstoreaccount1.blob.localhost:127.0.0.1"

  init:
    image: mcr.microsoft.com/azure-cli
    network_mode: service:azurite
    command: >
      sh -c "
        az storage container create --name test --account-name devstoreaccount1 --account-key Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw== --blob-endpoint http://azurite:10000/devstoreaccount1
        sleep inf
        "
    depends_on:
      - azurite


  bbb:
    network_mode: service:azurite
    build:
      context: ..
      dockerfile: e2e/Dockerfile
    environment:
      - BBB_AZBLOB_ENDPOINT=http://%s.blob.localhost:10000/
      - BBB_AZBLOB_ACCOUNTKEY=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==
    depends_on:
      - azurite
      - init
    volumes:
      - ..:/src
    working_dir: /src/e2e
    command: ["go", "test", "-v"]
